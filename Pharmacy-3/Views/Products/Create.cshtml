@{
	ViewBag.Title = "Add New Product";
}

<h2>Add New Product</h2>

<form id="createProductForm">
	<div class="form-group">
		<label for="ProductType">Product Type:</label>
		<select id="ProductType" name="ProductType" class="form-control">
			<option value="Consumables">Consumables</option>
			<option value="Devices">Devices</option>
			<option value="Drugs">Drugs</option>
		</select>
	</div>
	<div class="form-group">
		<label>UPC:</label>
		<input type="number" id="UPC" class="form-control" required />
	</div>
	<div class="form-group">
		<label>Name:</label>
		<input type="text" id="Name" class="form-control" required />
	</div>
	<div class="form-group">
		<label>Price:</label>
		<input type="text" id="Price" class="form-control" required placeholder="e.g., 123.45" />
	</div>
	<div class="form-group">
		<label>EDRPOU:</label>
		<input type="number" id="EDRPOU" class="form-control" required />
	</div>
	<div class="form-group" id="ExpirationDateDiv" style="display:none;">
		<label>Expiration Date:</label>
		<input type="date" id="ExpirationDate" class="form-control" />
	</div>
	<div class="form-group" id="ConsumableTypeDiv" style="display:none;">
		<label>Consumable Type:</label>
		<select id="ConsumableType" class="form-control">
			<option value="Patch">Patch</option>
			<option value="Syringe">Syringe</option>
			<option value="Needle">Needle</option>
			<option value="Gauze">Gauze</option>
		</select>
	</div>
	<div class="form-group" id="DeviceTypeDiv" style="display:none;">
		<label>Device Type:</label>
		<select id="DeviceType" class="form-control">
			<option value="Inhaler">Inhaler</option>
			<option value="Pulse_oximetr">Pulse Oximeter</option>
			<option value="Blood_pressure_monitor">Blood Pressure Monitor</option>
		</select>
	</div>
	<div class="form-group" id="DrugTypeDiv" style="display:none;">
		<label>Drug Type:</label>
		<select id="DrugType" class="form-control">
			<option value="Pills">Pills</option>
			<option value="Spray">Spray</option>
			<option value="Drops">Drops</option>
			<option value="Syrop">Syrup</option>
		</select>
	</div>
	<div class="form-group" id="NeedRecipeDiv" style="display:none;">
		<label>Need Recipe:</label>
		<input type="checkbox" id="NeedRecipe" />
	</div>
	<button type="button" id="addProductBtn" class="btn btn-primary">Add Product</button>
</form>

<div id="resultMessage" class="mt-3"></div>

<script>
	document.addEventListener("DOMContentLoaded", function () {
		handleProductTypeChange();
		document.getElementById("ProductType").addEventListener("change", handleProductTypeChange);

		document.getElementById("addProductBtn").addEventListener("click", function () {
			addProduct();
		});
	});

	function handleProductTypeChange() {
		const productType = document.getElementById("ProductType").value;

		document.getElementById("ExpirationDateDiv").style.display = (productType === "Consumables" || productType === "Drugs") ? "block" : "none";
		document.getElementById("ConsumableTypeDiv").style.display = (productType === "Consumables") ? "block" : "none";
		document.getElementById("DeviceTypeDiv").style.display = (productType === "Devices") ? "block" : "none";
		document.getElementById("DrugTypeDiv").style.display = (productType === "Drugs") ? "block" : "none";
		document.getElementById("NeedRecipeDiv").style.display = (productType === "Drugs") ? "block" : "none";
	}

	function addProduct() {
		const productType = document.getElementById("ProductType").value;

		const product = {
			ProductType: productType,
			UPC: document.getElementById("UPC").value,
			Name: document.getElementById("Name").value,
			Price: parseFloat(document.getElementById("Price").value).toFixed(2),
			EDRPOU: document.getElementById("EDRPOU").value,
			ExpirationDate: document.getElementById("ExpirationDate").value || null,
			ConsumableType: productType === "Consumables"
				? document.getElementById("ConsumableType").selectedIndex
				: null,
			DeviceType: productType === "Devices"
				? document.getElementById("DeviceType").selectedIndex
				: null,
			DrugType: productType === "Drugs"
				? document.getElementById("DrugType").selectedIndex
				: null,
			NeedRecipe: productType === "Drugs"
				? document.getElementById("NeedRecipe").checked
				: false
		};


		console.log("Sending JSON:", JSON.stringify(product));

		fetch('/api/productsapi', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify(product)
		})
			.then(response => {
				if (!response.ok) {
					return response.json().then(error => {
						let errorMessage = "Error: ";

						if (error.error) {
							errorMessage += error.error + "\n";
						}

						if (error.details) {
							errorMessage += "Details: " + error.details + "\n";
						}

						if (error.errors) {
							for (const [field, messages] of Object.entries(error.errors)) {
								errorMessage += `${field}: ${messages.join(", ")}\n`;
							}
						}

						alert(errorMessage);
						return;
					});
				}
				return response.json();
			})
			.then(data => {
				if (data) {
					alert(data.message);
					window.location.href = '/Products/Index';
				}
			})
			.catch(error => {
				console.error('Unexpected error:', error);
				alert('An unexpected error occurred. Please try again.');
			});

	}




	function getEnumValue(selectId) {
		const selectElement = document.getElementById(selectId);
		return selectElement.selectedIndex;
	}

</script>
