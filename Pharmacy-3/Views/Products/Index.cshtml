@model IEnumerable<Pharmacy_3.Models.Products.Product>
@{
	ViewBag.Title = "Products Admin Panel";
}

<h2>Products Admin Panel</h2>

<!-- Кнопка для переходу на сторінку створення нового продукту -->
<div class="mb-3">
	<a href="/Products/Create" class="btn btn-success">Add New Product</a>
</div>

<!-- Форма для фільтрації та кількості елементів на сторінці -->
<form id="filterForm">
	<div class="form-group">
		<label>Search by Name or UPC:</label>
		<input type="text" id="searchString" class="form-control" placeholder="Enter Name or UPC" />
	</div>
	<div class="form-group">
		<label>Items per Page:</label>
		<input type="number" id="pageSize" value="10" min="1" class="form-control" />
	</div>
	<br />
	<button type="button" id="filterBtn" class="btn btn-primary">Filter</button>
</form>

<!-- Таблиця для продуктів -->
<table class="table" id="productsTable">
	<thead>
		<tr>
			<th>
				<a href="#" onclick="loadProducts('name')">Name</a>
			</th>
			<th>
				<a href="#" onclick="loadProducts('upc')">UPC</a>
			</th>
			<th>
				<a href="#" onclick="loadProducts('price')">Price</a>
			</th>
			<th>Product Type</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		<!-- Дані завантажуватимуться через AJAX -->
	</tbody>
</table>

<!-- Пагінація -->
<div id="pagination" class="mt-3"></div>

<!-- JavaScript для завантаження даних з Web API -->
<script>
	let currentPage = 1;
	let currentSort = '';
	let pageSize = 10;

	document.addEventListener("DOMContentLoaded", function () {
		loadProducts();
		document.getElementById("filterBtn").addEventListener("click", function () {
			currentPage = 1;
			loadProducts();
		});
	});

	function loadProducts(sortOrder = '') {
		const searchString = document.getElementById("searchString").value || '';
		pageSize = document.getElementById("pageSize").value || 10;
		currentSort = sortOrder || currentSort;

		fetch(`/api/productsapi?searchString=${searchString}&sortOrder=${currentSort}&page=${currentPage}&pageSize=${pageSize}`)
			.then(response => response.json())
			.then(data => {
				renderTable(data.products);
				renderPagination(data.totalItems, data.pageSize, data.currentPage);
			})
			.catch(error => console.error('Error loading products:', error));
	}

	function renderTable(products) {
		const tableBody = document.querySelector("#productsTable tbody");
		tableBody.innerHTML = "";

		products.forEach(product => {
			const formattedPrice = parseFloat(product.price).toFixed(2); // Форматування ціни з 2 знаками після точки
			const row = `
					<tr>
						<td>${product.name}</td>
						<td>${product.upc}</td>
						<td>${formattedPrice}</td>
						<td>${product.productType}</td>
						<td>
							<a href="/Products/Details/${product.upc}" class="btn btn-info">Details</a>
							<a href="/Products/Edit/${product.upc}" class="btn btn-warning">Edit</a>
							<button onclick="deleteProduct(${product.upc})" class="btn btn-danger">Delete</button>
						</td>
					</tr>
				`;
			tableBody.innerHTML += row;
		});
	}


	function renderPagination(totalItems, pageSize, currentPage) {
		const paginationDiv = document.getElementById("pagination");
		const totalPages = Math.ceil(totalItems / pageSize);
		paginationDiv.innerHTML = "";

		if (currentPage > 1) {
			paginationDiv.innerHTML += `<button class="btn btn-secondary" onclick="changePage(${currentPage - 1})">&lt;</button>`;
		}

		for (let i = 1; i <= totalPages; i++) {
			paginationDiv.innerHTML += `<button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" onclick="changePage(${i})">${i}</button>`;
		}

		if (currentPage < totalPages) {
			paginationDiv.innerHTML += `<button class="btn btn-secondary" onclick="changePage(${currentPage + 1})">&gt;</button>`;
		}
	}

	function changePage(page) {
		currentPage = page;
		loadProducts();
	}

	function deleteProduct(id) {
		fetch(`/api/productsapi/${id}`, { method: "DELETE" })
			.then(response => {
				if (response.ok) {
					alert("Product deleted successfully!");
					loadProducts();
				} else {
					alert("Failed to delete product.");
				}
			});
	}
</script>
